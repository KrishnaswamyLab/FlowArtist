---

title: 05d01 UW Method on Single Cell Datasets


keywords: fastai
sidebar: home_sidebar

summary: "Run the UW model on all of our toy datasets (optionally, do so many times), and produce training gifs and loss charts for each."
description: "Run the UW model on all of our toy datasets (optionally, do so many times), and produce training gifs and loss charts for each."
nb_path: "05d01a UW Comparisons.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05d01a UW Comparisons.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">FRED</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1.14&#39;</span><span class="p">:</span> <span class="c1"># If using pytorch with MPS, use Apple silicon GPU acceleration</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">has_mps</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using device&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
<span class="c1"># sns.set_theme()</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">notebook</span> <span class="o">=</span> <span class="s2">&quot;05d01 UW Method on Single Cell Datasets.ipynb&quot;</span>
<span class="n">dataset_name</span> <span class="o">=</span> <span class="s2">&quot;bone marrow&quot;</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="s1">&#39;automatic&#39;</span>
<span class="n">flow_strength</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">smoothness_weight</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">flow_neighbor_loss_weight</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">contrastive_flow_loss_weight</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">diffdist_weight</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_neighbors</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Set-Up">Set Up<a class="anchor-link" href="#Set-Up"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">FRED.datasets</span> <span class="kn">import</span> <span class="n">double_helix</span><span class="p">,</span> <span class="n">directed_swiss_roll_delayed</span><span class="p">,</span> <span class="n">directed_sinh_branch</span><span class="p">,</span> <span class="n">rnavelo</span><span class="p">,</span> <span class="n">rnavelo_pcs</span>
<span class="kn">from</span> <span class="nn">FRED.data_processing</span> <span class="kn">import</span> <span class="n">dataloader_from_ndarray</span><span class="p">,</span> <span class="n">ManifoldWithVectorField</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">scvelo</span> <span class="k">as</span> <span class="nn">scv</span>
<span class="c1"># choose correct dataset</span>
<span class="k">if</span> <span class="n">dataset_name</span> <span class="o">==</span> <span class="s2">&quot;bone marrow&quot;</span><span class="p">:</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">scv</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">bonemarrow</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing data with pcs&quot;</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">n_pcs</span> <span class="o">=</span> <span class="n">rnavelo_pcs</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>processing data with pcs
Normalized count data: X, spliced, unspliced.
Logarithmized X.
computing neighbors
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>OMP: Info #277: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>    finished (0:00:07) --&gt; added 
    &#39;distances&#39; and &#39;connectivities&#39;, weighted adjacency matrices (adata.obsp)
computing moments based on connectivities
    finished (0:00:03) --&gt; added 
    &#39;Ms&#39; and &#39;Mu&#39;, moments of un/spliced abundances (adata.layers)
computing velocities
    finished (0:00:05) --&gt; added 
    &#39;velocity&#39;, velocity vectors for each individual cell (adata.layers)
computing velocity graph (using 1/8 cores)
    finished (0:00:26) --&gt; added 
    &#39;velocity_graph&#39;, sparse matrix with cosine correlations (adata.uns)
computing velocity embedding
    finished (0:00:01) --&gt; added
    &#39;velocity_pca&#39;, embedded velocity vectors (adata.obsm)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">X</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([5780, 30])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have to build a directed graph from this raw data, which will serve as input to the UW algorithm.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">FRED.data_processing</span> <span class="kn">import</span> <span class="n">flashlight_affinity_matrix</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">flashlight_affinity_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Set sigma =  4.438772
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
Input <span class="ansi-green-fg">In [5]</span>, in <span class="ansi-cyan-fg">&lt;cell line: 2&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-bold" style="color: rgb(0,135,0)">from</span> <span class="ansi-bold" style="color: rgb(0,0,255)">FRED</span><span class="ansi-bold" style="color: rgb(0,0,255)">.</span><span class="ansi-bold" style="color: rgb(0,0,255)">data_processing</span> <span class="ansi-bold" style="color: rgb(0,135,0)">import</span> flashlight_affinity_matrix
<span class="ansi-green-fg">----&gt; 2</span> A <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">flashlight_affinity_matrix</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">X</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">flow</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">10</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> A <span style="color: rgb(98,98,98)">=</span> A<span style="color: rgb(98,98,98)">.</span>numpy()

File <span class="ansi-green-fg">/gpfs/ysm/project/sumry2022/sumry2022_gt392/FRED/FRED/data_processing.py:121</span>, in <span class="ansi-cyan-fg">flashlight_affinity_matrix</span><span class="ansi-blue-fg">(X, flow, k, sigma, flow_strength)</span>
<span class="ansi-green-intense-fg ansi-bold">    119</span> <span style="color: rgb(95,135,135)"># convert back to tensors</span>
<span class="ansi-green-intense-fg ansi-bold">    120</span> X <span style="color: rgb(98,98,98)">=</span> torch<span style="color: rgb(98,98,98)">.</span>Tensor(X)
<span class="ansi-green-fg">--&gt; 121</span> flow <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">torch</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">Tensor</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">flow</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    122</span> A <span style="color: rgb(98,98,98)">=</span> affinity_matrix_from_pointset_to_pointset(X, X, flow, sigma<span style="color: rgb(98,98,98)">=</span>sigma, flow_strength<span style="color: rgb(98,98,98)">=</span>flow_strength)
<span class="ansi-green-intense-fg ansi-bold">    123</span> <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> A

<span class="ansi-red-fg">TypeError</span>: expected TensorOptions(dtype=float, device=cpu, layout=Strided, requires_grad=false (default), pinned_memory=false (default), memory_format=(nullopt)) (got TensorOptions(dtype=double, device=cpu, layout=Strided, requires_grad=false (default), pinned_memory=false (default), memory_format=(nullopt)))</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Set-up-the-model">Set up the model<a class="anchor-link" href="#Set-up-the-model"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">def</span> <span class="nf">UW_directed_embedding</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replicates the velocity-embedding diffusion map from the UW paper.</span>
<span class="sd">    Input W, the directed graph, and m, the number of diffusion coordinates to keep.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># steps 1-6 (estimate coordinates according to diffusion map)</span>
    <span class="c1"># step 1</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">W</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># symmetric affinity matrix</span>

    <span class="c1"># step 2</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="c1"># degree matrix</span>

    <span class="c1"># step 3</span>
    <span class="n">Qinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Qinv</span><span class="nd">@S@Qinv</span> <span class="c1"># anisotropic normalized affinity matrix</span>

    <span class="c1"># step 4</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="c1"># normalized degree matrix</span>
    <span class="n">Q1inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Q1</span><span class="p">)</span> <span class="c1"># </span>
    
    <span class="c1"># step 5</span>
    <span class="n">Hss</span> <span class="o">=</span> <span class="n">Q1inv</span><span class="nd">@V</span> <span class="c1"># diffusion matrix (dividing affinity matrix by row sums)</span>

    <span class="c1"># step 6</span>
    <span class="n">eig_vals</span><span class="p">,</span> <span class="n">eig_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">Hss</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eig_vals</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">eig_vecs</span> <span class="o">=</span> <span class="n">eig_vecs</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">eig_vecs</span><span class="p">[:,:(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># first (m+1) right eigenvectors</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">eig_vecs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:(</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># first m significant right eigenvectors (coordinates of points in embedding)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span> <span class="c1"># diagonal matrix of (m+1) significant eigenvalues</span>


    <span class="c1"># step 7-8: estimate the density</span>
    <span class="n">density</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    evals, evecs = scipy.linalg.eig(Hss, left = True, right = False)</span>
<span class="sd">    pi = evecs[np.where(evals == 1)] # left eigenvector of Hss with eigenvalue 1</span>
<span class="sd">    density = pi/sum(pi) # normalize</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># step 9-13: estimate vector field r</span>
    <span class="c1"># step 9</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># step 10</span>
    <span class="n">Pinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">Pinv</span><span class="nd">@W@Pinv</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

    <span class="c1"># step 11</span>
    <span class="n">P1inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">P1</span><span class="p">)</span>
    <span class="n">Haa</span> <span class="o">=</span> <span class="n">P1</span><span class="nd">@T</span>

    <span class="n">R</span> <span class="o">=</span> <span class="p">((</span><span class="n">Haa</span> <span class="o">-</span> <span class="n">Hss</span><span class="p">)</span><span class="nd">@phi</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># vector field components in the direction of the corresponding coordinates of the embedding</span>

    <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">fields</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">coords</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">velocities</span> <span class="o">=</span> <span class="n">UW_directed_embedding</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Results">Results<a class="anchor-link" href="#Results"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">visualize_UW_dir_emb</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
    <span class="c1"># plot only a fraction of the vectors, so as not to blot everything out</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.25</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">fields</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">fields</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Diffusion Map&quot;</span><span class="p">)</span>
<span class="n">visualize_UW_dir_emb</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">FRED.datasets</span> <span class="kn">import</span> <span class="n">plot_directed_2d</span>
<span class="n">plot_directed_2d</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">equal_aspect_ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;UW Diffusion Map&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Qualitative-analyses">Qualitative analyses<a class="anchor-link" href="#Qualitative-analyses"> </a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We combine the embedded points with their velocities in the embedding space.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">embedded_points</span> <span class="o">=</span> <span class="n">coords</span>
<span class="n">embedded_velocities</span> <span class="o">=</span> <span class="n">velocities</span>
<span class="n">points_and_flows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">embedded_points</span><span class="p">,</span> <span class="n">embedded_velocities</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">points_and_flows</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn</span> 
<span class="n">silhouette_points</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">silhouette_score</span><span class="p">(</span><span class="n">embedded_points</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">silhouette_points_and_flows</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">silhouette_score</span><span class="p">(</span><span class="n">points_and_flows</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Nearest-Neighbors-Classifier-Score">Nearest Neighbors Classifier Score<a class="anchor-link" href="#Nearest-Neighbors-Classifier-Score"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">points_and_flows</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="n">neighClass</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">neighClass</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">knn_classifier_score</span> <span class="o">=</span> <span class="n">neighClass</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;## SCORES ## </span><span class="se">\n</span><span class="s2"> silhouette score w/o flows: </span><span class="si">{</span><span class="n">silhouette_points</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"> silhouette score w/ flows:  </span><span class="si">{</span><span class="n">silhouette_points_and_flows</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> kNN Classifier </span><span class="si">{</span><span class="n">knn_classifier_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Write-results-to-spreadsheet">Write results to spreadsheet<a class="anchor-link" href="#Write-results-to-spreadsheet"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">secrets</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="n">alphabet</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
<span class="n">unid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secrets</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">alphabet</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>  <span class="c1"># for a 20-character password</span>
<span class="n">unid</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="n">spread_name</span> <span class="o">=</span> <span class="n">notebook</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spread_name</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
        <span class="p">[</span><span class="n">unid</span><span class="p">,</span> 
         <span class="n">sigma</span><span class="p">,</span> 
         <span class="n">flow_strength</span><span class="p">,</span> 
         <span class="n">flow_neighbor_loss_weight</span><span class="p">,</span>
         <span class="n">smoothness_weight</span><span class="p">,</span> 
         <span class="n">diffdist_weight</span><span class="p">,</span> 
         <span class="n">silhouette_points</span><span class="p">,</span>
         <span class="n">silhouette_points_and_flows</span><span class="p">,</span>
         <span class="n">knn_classifier_score</span>
        <span class="p">])</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

